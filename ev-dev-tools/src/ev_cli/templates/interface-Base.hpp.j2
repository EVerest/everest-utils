{% from "helper_macros.j2" import handle_cmd_signature, list_json_types, var_to_cpp, var_to_any, print_template_info, print_spdx_line %}
{{ print_spdx_line('Apache-2.0') }}
#ifndef {{ info.hpp_guard }}
#define {{ info.hpp_guard }}

{{ print_template_info('0.0.2') }}

#include <framework/ModuleAdapter.hpp>

class {{ info.class_name }} : public Everest::ImplementationBase {
public:
    {{ info.class_name }}(Everest::ModuleAdapter* ev, const std::string& name) : Everest::ImplementationBase(), _ev(ev), _name(name) {};

protected:
    {% if not vars %}
    // no variables defined for this interface
    {% else %}
    // publish functions for variables
    {% for var in vars %}
    void publish_{{ var.name }}({{ var.cpp_type }} value) {
        _ev->publish(_name, "{{ var.name }}", value);
    }
    {% endfor %}
    {% endif %}

    {% if not cmds %}
    // no commands defined for this interface
    {% else %}
    // command handler functions (virtual)
    {% for cmd in cmds %}
    {{ handle_cmd_signature(cmd) }} = 0;
    {% endfor %}
    {% endif %}

private:
    Everest::ModuleAdapter* const _ev;
    const std::string _name;

    // helper function for getting all commands
    void _gather_cmds(std::vector<Everest::cmd>& cmds) override {
    {% if not cmds %}
        // this interface does not offer any commands
    {% else %}
        {% for cmd in cmds %}
        // {{ cmd.name }} command
        Everest::cmd {{ cmd.name }}_cmd;
        {{ cmd.name }}_cmd.impl_id = _name;
        {{ cmd.name }}_cmd.cmd_name = "{{ cmd.name }}";
        {% if not cmd.args %}
        // cmd {{ cmd.name }} has no arguments
        {% else %}
        {{ cmd.name }}_cmd.arg_types = {
            {% for arg in cmd.args %}
            {"{{ arg.name }}", {{ list_json_types(arg.json_type) + '}' }}{{ ',' if not loop.last }}
            {% endfor %}
        };
        {% endif %}
        {{ cmd.name }}_cmd.cmd = [this](Parameters args) -> Result {
            {% for arg in cmd.args %}
            auto {{ arg.name }} = {{ var_to_cpp(arg) }}(args["{{ arg.name }}"]);
            {% endfor %}

            {{ 'auto result = ' if cmd.result }}this->handle_{{ cmd.name }}(
                {%- for arg in cmd.args -%}
                {{ arg.name }}{{ ', ' if not loop.last }}
                {%- endfor -%}
            );
            return {{ var_to_any(cmd.result, 'result') if cmd.result else 'boost::none'}};
        };
        {% if cmd.result %}
        {{ cmd.name }}_cmd.return_type = {{ list_json_types(cmd.result.json_type) }};
        {% endif %}
        cmds.emplace_back(std::move({{ cmd.name }}_cmd));
        {% if not loop.last %}

        {% endif %}
        {% endfor %}
    {% endif %}
    };
};

#endif // {{ info.hpp_guard }}
